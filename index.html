<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剑三活动匹配系统</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background-color: #2196f3;
            color: white;
        }

        .content {
            background-color: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-height: 500px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        h3 {
            color: #555;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2196f3;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .profession-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .tag {
            padding: 8px 12px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            user-select: none;
        }

        .tag:hover {
            border-color: #2196f3;
        }

        .tag.selected {
            background-color: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .tag.healer {
            background-color: #e8f5e9;
            border-color: #81c784;
            color: #388e3c;
        }

        .tag.healer.selected {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 5px 0;
        }

        .button:hover {
            background-color: #1976d2;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .button.success {
            background-color: #4caf50;
        }

        .button.danger {
            background-color: #f44336;
        }

        .button.small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .user-item, .team-item, .signup-item {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item.signed-up {
            background-color: #e8f5e9;
            border-color: #a5d6a7;
        }

        .user-info, .team-info {
            flex: 1;
        }

        .user-name, .team-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .user-professions, .team-tips {
            font-size: 14px;
            color: #666;
        }

        /* 加粗高亮队伍说明 */
        .team-tips {
            font-weight: 600;
            color: #2196f3;
            background-color: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
        }

        .team-meta {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .status-bar {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #1976d2;
        }

        .status-bar.online {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .team-members {
            margin-top: 8px;
            font-size: 14px;
        }

        .member-slot {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #e3f2fd;
            border-radius: 4px;
            font-size: 12px;
        }

        .member-slot.empty {
            background-color: #f5f5f5;
            color: #999;
        }

        .member-slot.dps {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
        }

        .member-slot.healer {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
        }

        .pool-info {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .match-result {
            margin-top: 20px;
        }

        .team {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .team-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .rules-section {
            margin-bottom: 30px;
        }

        .rules-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .rule-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .rule-item h4 {
            color: #2196f3;
            margin-bottom: 8px;
        }

        .edit-tips-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .admin-section {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            color: #f57c00;
        }

        .team-container {
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .join-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f7ff;
            border: 1px solid #bbdefb;
            border-radius: 8px;
        }

        .action-section {
            margin-top: 10px;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .login-reminder {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #f57c00;
        }

        .current-user-display {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            color: #1976d2;
        }

        .current-user-display.not-logged {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .create-team-dialog {
            background-color: #f0f7ff;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .rule-number {
            display: inline-block;
            background-color: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 8px;
            font-size: 14px;
        }

        .quick-tips {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .quick-tips h4 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .quick-tips ul {
            margin-left: 20px;
        }

        .quick-tips li {
            margin-bottom: 5px;
            color: #555;
        }

        .signup-button-container {
            text-align: center;
            padding: 20px;
            background-color: #f0f7ff;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .match-button-container {
            text-align: center;
            margin: 20px 0;
        }

        .user-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .nav-tab {
                font-size: 14px;
                padding: 12px 8px;
            }
            
            .profession-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('user')">用户中心</button>
            <button class="nav-tab" onclick="switchTab('match')">对排活动</button>
            <button class="nav-tab" onclick="switchTab('jjc')">JJC组队</button>
            <button class="nav-tab" onclick="switchTab('rules')">活动规则</button>
        </div>
        
        <div class="content">
            <div id="connection-status" class="status-bar">
                正在连接服务器...
            </div>
            
            <!-- 用户中心页面 -->
            <div id="user-page" class="page active">
                <h2>用户中心</h2>
                <div id="user-current-user" class="current-user-display"></div>
                <div id="user-message"></div>
                
                <!-- 注册/登录 -->
                <div class="form-group">
                    <label for="userId">用户ID</label>
                    <input type="text" id="userId" placeholder="请输入你的游戏ID">
                    <button class="button success" onclick="registerOrLogin()">注册/登录</button>
                </div>
                
                <!-- 编辑超爱心法 -->
                <div id="love-professions-section" style="display:none;">
                    <h3>编辑你的超爱心法（可多选）</h3>
                    <div class="form-group">
                        <label>DPS职业</label>
                        <div class="profession-grid" id="love-dps-container"></div>
                    </div>
                    <div class="form-group">
                        <label>奶妈职业</label>
                        <div class="profession-grid" id="love-healer-container"></div>
                    </div>
                    <button class="button" onclick="saveLoveProfessions()">保存超爱心法</button>
                </div>
                
                <!-- 用户列表 -->
                <h3>所有用户</h3>
                <div id="all-users-list"></div>
            </div>
            
            <!-- 对排活动页面 -->
            <div id="match-page" class="page">
                <h2>对排活动</h2>
                <div id="match-current-user" class="current-user-display"></div>
                <div id="match-message"></div>
                
                <!-- 报名按钮区域 -->
                <div class="signup-button-container">
                    <div class="status-bar" style="margin-bottom: 15px;">
                        当前报名人数：<span id="signup-count">0</span> 人（需要至少6人才能开始抽签）
                    </div>
                    <button class="button success" onclick="signupMatch()" id="signup-btn">报名参加</button>
                    <button class="button danger" onclick="cancelSignup()" id="cancel-signup-btn" style="display:none;">取消报名</button>
                </div>
                
                <!-- 管理员设置职业池 -->
                <div class="admin-section">
                    <h3>管理员：设置本次活动职业池</h3>
                    <div class="form-group">
                        <label>选择本次活动可用的DPS职业</label>
                        <div class="profession-grid" id="pool-dps-container"></div>
                    </div>
                    <div class="form-group">
                        <label>选择本次活动可用的奶妈职业</label>
                        <div class="profession-grid" id="pool-healer-container"></div>
                    </div>
                    <button class="button" onclick="saveMatchPool()">保存职业池设置</button>
                </div>
                
                <!-- 当前职业池 -->
                <div id="current-pool-info" class="pool-info" style="display:none;">
                    <h4>当前活动职业池</h4>
                    <div id="current-pool-content"></div>
                </div>
                
                <!-- 抽签按钮 -->
                <div class="match-button-container">
                    <button class="button success" onclick="startMatching()" id="match-button" disabled style="width: 100%;">
                        开始抽签分队（可多次抽签）
                    </button>
                </div>
                
                <div id="match-results" class="match-result"></div>
                
                <!-- 所有用户列表（合并显示） -->
                <div class="user-list-header">
                    <h3>所有用户</h3>
                    <div style="font-size: 12px; color: #666;">
                        <span style="color: #4caf50;">● 已报名</span> 
                        <span style="margin-left: 10px;">● 未报名</span>
                    </div>
                </div>
                <div id="all-match-users"></div>
            </div>
            
            <!-- JJC组队页面 -->
            <div id="jjc-page" class="page">
                <h2>JJC组队预约</h2>
                <div id="jjc-current-user" class="current-user-display"></div>
                <div id="jjc-message"></div>
                
                <!-- 未登录提示 -->
                <div id="jjc-login-reminder" class="login-reminder" style="display:none;">
                    请先在用户中心登录后再进行组队操作
                </div>
                
                <!-- 创建队伍表单 -->
                <div id="create-team-form" class="create-team-dialog" style="display:none;">
                    <h3>创建新队伍</h3>
                    <div class="form-group">
                        <label for="team-date">开打日期</label>
                        <input type="date" id="team-date">
                    </div>
                    <div class="form-group">
                        <label for="team-tips">队伍说明（请注明时间和段位）</label>
                        <textarea id="team-tips" placeholder="例如：晚上8点开打，1700段位以上"></textarea>
                    </div>
                    <button class="button success" onclick="confirmCreateTeam()">确认创建</button>
                    <button class="button" onclick="cancelCreateTeam()">取消</button>
                </div>
                
                <!-- 创建队伍按钮 -->
                <div id="jjc-create-section" style="text-align: center; margin-bottom: 20px;">
                    <button class="button success" onclick="showCreateTeamForm()">创建新队伍</button>
                </div>
                
                <!-- 队伍列表 -->
                <h3>队伍列表</h3>
                <div id="teams-list"></div>
            </div>
            
            <!-- 活动规则页面 -->
            <div id="rules-page" class="page">
                <h2>活动规则说明</h2>
                <div id="rules-current-user" class="current-user-display"></div>
                
                <div class="quick-tips">
                    <h4>快速上手指南</h4>
                    <ul>
                        <li>第一步：在用户中心注册账号</li>
                        <li>第二步：设置你的超爱心法（擅长的职业）</li>
                        <li>第三步：参加对排活动或JJC组队</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h3><span class="rule-number">1</span>用户系统</h3>
                    <div class="rule-item">
                        <h4>如何使用</h4>
                        <p>• 输入游戏ID（角色名）即可快速注册</p>
                        <p>• 系统会记住你的信息，下次输入相同ID即可登录</p>
                        <p>• 超爱心法是你最擅长的职业，活动时会优先分配</p>
                        <p>• 可以同时选择多个心法作为超爱心法</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3><span class="rule-number">2</span>对排活动</h3>
                    <div class="rule-item">
                        <h4>活动流程</h4>
                        <p><strong>准备阶段：</strong></p>
                        <p>• 管理员设置本次活动可用的职业池</p>
                        <p>• 只有职业池中的职业会被分配</p>
                        <br>
                        <p><strong>报名阶段：</strong></p>
                        <p>• 玩家点击"报名参加"按钮</p>
                        <p>• 可以随时取消报名</p>
                        <p>• 满6人即可开始</p>
                        <br>
                        <p><strong>分队阶段：</strong></p>
                        <p>• 系统自动将玩家分成3人小队</p>
                        <p>• 每队配置：2个DPS + 1个奶妈</p>
                        <p>• 优先分配你的超爱心法职业</p>
                        <p>• 可以多次抽签重新分配</p>
                    </div>
                    <div class="rule-item">
                        <h4>小贴士</h4>
                        <p>• 提前设置好超爱心法，可以玩到擅长的职业</p>
                        <p>• 如果报名人数不是3的倍数，会有人轮空</p>
                        <p>• 分队结果完全随机，确保公平</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3><span class="rule-number">3</span>JJC组队</h3>
                    <div class="rule-item">
                        <h4>创建队伍</h4>
                        <p>• 点击"创建新队伍"按钮</p>
                        <p>• 选择开打日期（默认当天）</p>
                        <p>• 填写队伍说明（时间、段位要求等）</p>
                        <p>• 队伍会按创建者命名（如：张三的小队1）</p>
                        <p>• 过期队伍每天晚上12点自动清理</p>
                    </div>
                    <div class="rule-item">
                        <h4>队伍配置</h4>
                        <p>• 每队固定3人：2个DPS + 1个奶妈</p>
                        <p>• 加入时系统会自动判断职业类型</p>
                        <p>• 职业槽位满后无法再加入同类型职业</p>
                        <p>• 创建者可以修改说明或删除队伍</p>
                    </div>
                    <div class="rule-item">
                        <h4>注意事项</h4>
                        <p>• 请认真阅读队伍说明，确认时间合适</p>
                        <p>• 加入后请准时参加，不要鸽子</p>
                        <p>• 有事无法参加请提前退出</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3><span class="rule-number">4</span>职业一览</h3>
                    <div class="rule-item">
                        <h4>DPS职业（22个）</h4>
                        <p>和尚、冰心、花间游、气纯、剑纯、天策、藏剑、毒经、鲸鱼、田螺、明教、丐帮、苍云、莫问、霸刀、蓬莱、凌雪、衍天、无方、刀宗、万灵、段氏</p>
                    </div>
                    <div class="rule-item">
                        <h4>治疗职业（5个）</h4>
                        <p>奶秀、奶毒、奶花、奶歌、奶药</p>
                    </div>
                </div>
                
                <div class="quick-tips">
                    <h4>常见问题</h4>
                    <ul>
                        <li><strong>Q：忘记自己的ID怎么办？</strong><br>A：使用游戏内的角色名重新登录即可</li>
                        <li><strong>Q：可以修改超爱心法吗？</strong><br>A：可以，随时在用户中心修改</li>
                        <li><strong>Q：对排活动职业是怎么分配的？</strong><br>A：优先你的超爱心法，没有则随机</li>
                        <li><strong>Q：JJC队伍过期了怎么办？</strong><br>A：过期队伍会自动清理，需要重新创建</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置 - 请替换为你自己的配置
        const firebaseConfig = {
            // 在这里填入你的Firebase配置
          apiKey: "AIzaSyAqAl228PwAygdjgmbI-B7zvpaGmgkNREE",
          authDomain: "user-ba917.firebaseapp.com",
          databaseURL: "https://user-ba917-default-rtdb.firebaseio.com",
          projectId: "user-ba917",
          storageBucket: "user-ba917.firebasestorage.app",
          messagingSenderId: "648289853069",
          appId: "1:648289853069:web:fbfdbd13b6023fca928cc4",
        };

        // 职业数据
        const dpsProfessions = [
            '和尚', '冰心', '花间游', '气纯', '剑纯', '天策', '藏剑', '毒经', 
            '鲸鱼', '田螺', '明教', '丐帮', '苍云', '莫问', '霸刀', '蓬莱', 
            '凌雪', '衍天', '无方', '刀宗', '万灵', '段氏'
        ];
        
        const healerProfessions = ['奶秀', '奶毒', '奶花', '奶歌', '奶药'];
        
        // 全局变量
        let database;
        let currentUser = null;
        let users = {};
        let matchPool = { dps: [], healers: [] };
        let matchSignups = {};
        let jjcTeams = {};
        let userTeamCounts = {}; // 记录每个用户创建的队伍数量
        
        // 初始化Firebase
        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // 监听连接状态
                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusEl = document.getElementById('connection-status');
                    if (connected) {
                        statusEl.className = 'status-bar online';
                        statusEl.innerHTML = '✅ 已连接到服务器';
                    } else {
                        statusEl.className = 'status-bar';
                        statusEl.innerHTML = '❌ 连接已断开';
                    }
                });
                
                // 监听数据变化
                database.ref('users').on('value', (snapshot) => {
                    users = snapshot.val() || {};
                    updateAllUsersList();
                    updateAllMatchUsers();
                });
                
                database.ref('matchPool').on('value', (snapshot) => {
                    matchPool = snapshot.val() || { dps: [], healers: [] };
                    updateMatchPoolDisplay();
                });
                
                database.ref('matchSignups').on('value', (snapshot) => {
                    matchSignups = snapshot.val() || {};
                    updateSignupCount();
                    updateMatchPageUserStatus();
                    updateAllMatchUsers();
                });
                
                database.ref('jjcTeams').on('value', (snapshot) => {
                    jjcTeams = snapshot.val() || {};
                    updateTeamsList();
                    cleanExpiredTeams();
                });
                
                // 获取用户创建的队伍计数
                database.ref('userTeamCounts').on('value', (snapshot) => {
                    userTeamCounts = snapshot.val() || {};
                });
                
                // 设置定时清理任务
                setInterval(cleanExpiredTeams, 60000); // 每分钟检查一次
                
                return true;
            } catch (error) {
                console.error('Firebase初始化失败:', error);
                return false;
            }
        }
        
        // 清理过期队伍
        function cleanExpiredTeams() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            Object.entries(jjcTeams).forEach(([teamId, team]) => {
                if (team.date) {
                    const teamDate = new Date(team.date);
                    if (teamDate < today) {
                        database.ref(`jjcTeams/${teamId}`).remove();
                    }
                }
            });
        }
        
        // 获取今天的日期字符串
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 格式化日期显示
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}月${day}日`;
        }
        
        // 格式化时间显示
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // 切换标签页
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-page`).classList.add('active');
            
            // 切换到JJC页面时检查登录状态
            if (tab === 'jjc') {
                updateJJCLoginStatus();
            }
            
            // 更新所有页面的当前用户显示
            updateCurrentUserDisplay();
            
            clearMessages();
        }
        
        // 更新当前用户显示
        function updateCurrentUserDisplay() {
            const displays = [
                'user-current-user',
                'match-current-user',
                'jjc-current-user',
                'rules-current-user'
            ];
            
            displays.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (currentUser) {
                        element.className = 'current-user-display';
                        element.innerHTML = `当前用户：<strong>${currentUser}</strong>`;
                    } else {
                        element.className = 'current-user-display not-logged';
                        element.innerHTML = '当前状态：<strong>未登录</strong>';
                    }
                }
            });
        }
        
        // 更新JJC页面登录状态
        function updateJJCLoginStatus() {
            const loginReminder = document.getElementById('jjc-login-reminder');
            const createSection = document.getElementById('jjc-create-section');
            
            if (!currentUser) {
                loginReminder.style.display = 'block';
                createSection.style.display = 'none';
            } else {
                loginReminder.style.display = 'none';
                createSection.style.display = 'block';
            }
            
            // 更新队伍列表
            updateTeamsList();
        }
        
        // 注册或登录
        function registerOrLogin() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                showMessage('user-message', '请输入用户ID', 'error');
                return;
            }
            
            currentUser = userId;
            
            if (!users[userId]) {
                // 新用户注册
                database.ref(`users/${userId}`).set({
                    loveProfessions: [],
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                showMessage('user-message', `欢迎 ${userId}！请设置你的超爱心法`, 'success');
            } else {
                showMessage('user-message', `欢迎回来 ${userId}！`, 'success');
            }
            
            // 显示超爱心法编辑区
            document.getElementById('love-professions-section').style.display = 'block';
            initLoveProfessions();
            
            // 更新所有页面状态
            updateCurrentUserDisplay();
            updateMatchPageUserStatus();
            updateJJCLoginStatus();
        }
        
        // 初始化超爱心法选择
        function initLoveProfessions() {
            const dpsContainer = document.getElementById('love-dps-container');
            const healerContainer = document.getElementById('love-healer-container');
            
            dpsContainer.innerHTML = '';
            healerContainer.innerHTML = '';
            
            const userLoveProfessions = users[currentUser]?.loveProfessions || [];
            
            dpsProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'dps', userLoveProfessions.includes(prof));
                dpsContainer.appendChild(tag);
            });
            
            healerProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'healer', userLoveProfessions.includes(prof));
                healerContainer.appendChild(tag);
            });
        }
        
        // 初始化职业池选择（管理员）
        function initPoolProfessions() {
            const dpsContainer = document.getElementById('pool-dps-container');
            const healerContainer = document.getElementById('pool-healer-container');
            
            dpsContainer.innerHTML = '';
            healerContainer.innerHTML = '';
            
            dpsProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'dps', matchPool.dps?.includes(prof));
                dpsContainer.appendChild(tag);
            });
            
            healerProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'healer', matchPool.healers?.includes(prof));
                healerContainer.appendChild(tag);
            });
        }
        
        // 创建职业标签
        function createProfessionTag(profession, type, selected = false) {
            const tag = document.createElement('div');
            tag.className = `tag ${type} ${selected ? 'selected' : ''}`;
            tag.textContent = profession;
            tag.onclick = () => tag.classList.toggle('selected');
            return tag;
        }
        
        // 保存超爱心法
        function saveLoveProfessions() {
            if (!currentUser) {
                showMessage('user-message', '请先登录', 'error');
                return;
            }
            
            const selected = [...document.querySelectorAll('#love-professions-section .tag.selected')]
                .map(tag => tag.textContent);
            
            database.ref(`users/${currentUser}/loveProfessions`).set(selected);
            showMessage('user-message', '超爱心法保存成功！', 'success');
        }
        
        // 保存职业池设置（管理员）
        function saveMatchPool() {
            const selectedDps = [...document.querySelectorAll('#pool-dps-container .tag.selected')]
                .map(tag => tag.textContent);
            const selectedHealers = [...document.querySelectorAll('#pool-healer-container .tag.selected')]
                .map(tag => tag.textContent);
            
            if (selectedDps.length === 0 || selectedHealers.length === 0) {
                showMessage('match-message', '请至少选择一个DPS和一个奶妈职业', 'error');
                return;
            }
            
            database.ref('matchPool').set({
                dps: selectedDps,
                healers: selectedHealers
            });
            
            showMessage('match-message', '职业池设置成功！', 'success');
        }
        
        // 更新用户列表
        function updateAllUsersList() {
            const container = document.getElementById('all-users-list');
            container.innerHTML = '';
            
            Object.entries(users).forEach(([userId, user]) => {
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${userId}</div>
                        <div class="user-professions">超爱心法：${user.loveProfessions?.join('、') || '未设置'}</div>
                    </div>
                    <div>
                        <button class="button small danger" onclick="deleteUser('${userId}')">删除用户</button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无注册用户</p>';
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm(`确定要删除用户 ${userId} 吗？`)) {
                database.ref(`users/${userId}`).remove();
                // 同时删除该用户的报名信息
                database.ref(`matchSignups/${userId}`).remove();
                // 删除该用户在JJC队伍中的信息
                Object.keys(jjcTeams).forEach(teamId => {
                    if (jjcTeams[teamId].creator === userId) {
                        database.ref(`jjcTeams/${teamId}`).remove();
                    } else {
                        database.ref(`jjcTeams/${teamId}/members/${userId}`).remove();
                    }
                });
                // 重置该用户的队伍计数
                database.ref(`userTeamCounts/${userId}`).remove();
                showMessage('user-message', `用户 ${userId} 已删除`, 'success');
            }
        }
        
        // 更新职业池显示
        function updateMatchPoolDisplay() {
            initPoolProfessions();
            
            if (matchPool.dps?.length > 0 || matchPool.healers?.length > 0) {
                document.getElementById('current-pool-info').style.display = 'block';
                document.getElementById('current-pool-content').innerHTML = `
                    <div><strong>DPS职业：</strong>${matchPool.dps?.join('、') || '未设置'}</div>
                    <div><strong>奶妈职业：</strong>${matchPool.healers?.join('、') || '未设置'}</div>
                `;
            } else {
                document.getElementById('current-pool-info').style.display = 'none';
            }
        }
        
        // 更新所有用户列表（合并显示）
        function updateAllMatchUsers() {
            const container = document.getElementById('all-match-users');
            container.innerHTML = '';
            
            Object.entries(users).forEach(([userId, user]) => {
                const isSignedUp = matchSignups[userId];
                const item = document.createElement('div');
                item.className = `user-item ${isSignedUp ? 'signed-up' : ''}`;
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${userId} ${isSignedUp ? '<span style="color: #4caf50; font-weight: normal;">[已报名]</span>' : ''}</div>
                        <div class="user-professions">超爱心法：${user.loveProfessions?.join('、') || '未设置'}</div>
                    </div>
                    <div>
                        ${currentUser === userId ? 
                            (isSignedUp ? 
                                '<span style="color: #4caf50;">已报名</span>' : 
                                '<button class="button small success" onclick="quickSignup()">快速报名</button>'
                            ) : 
                            ''
                        }
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无注册用户</p>';
            }
        }
        
        // 更新报名人数
        function updateSignupCount() {
            const count = Object.keys(matchSignups).length;
            document.getElementById('signup-count').textContent = count;
            document.getElementById('match-button').disabled = count < 6;
        }
        
        // 快速报名
        function quickSignup() {
            if (!currentUser) {
                showMessage('match-message', '请先登录', 'error');
                return;
            }
            signupMatch();
        }
        
        // 报名对排
        function signupMatch() {
            if (!currentUser) {
                showMessage('match-message', '请先登录', 'error');
                return;
            }
            
            if (!matchPool.dps?.length || !matchPool.healers?.length) {
                showMessage('match-message', '管理员还未设置职业池，请稍后再试', 'error');
                return;
            }
            
            database.ref(`matchSignups/${currentUser}`).set({
                userId: currentUser,
                signedUpAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            showMessage('match-message', `报名成功！`, 'success');
        }
        
        // 取消报名
        function cancelSignup() {
            if (!currentUser) return;
            
            database.ref(`matchSignups/${currentUser}`).remove();
            showMessage('match-message', '已取消报名', 'success');
        }
        
        // 更新用户在对排页面的状态
        function updateMatchPageUserStatus() {
            if (currentUser && matchSignups[currentUser]) {
                document.getElementById('signup-btn').style.display = 'none';
                document.getElementById('cancel-signup-btn').style.display = 'inline-block';
            } else {
                document.getElementById('signup-btn').style.display = 'inline-block';
                document.getElementById('cancel-signup-btn').style.display = 'none';
            }
        }
        
        // 开始匹配 - 重要修改：不清空报名列表
        function startMatching() {
            const signupsList = Object.values(matchSignups).map(signup => ({
                id: signup.userId,
                ...users[signup.userId]
            }));
            
            if (signupsList.length < 6) {
                showMessage('match-message', '报名人数不足6人', 'error');
                return;
            }
            
            // 随机打乱用户 - 使用副本而不影响原数组
            const shuffled = shuffle([...signupsList]);
            const teams = [];
            const tempShuffled = [...shuffled]; // 创建临时副本用于分组
            
            // 分配队伍
            while (tempShuffled.length >= 3) {
                const team = [];
                for (let i = 0; i < 3; i++) {
                    const player = tempShuffled.shift();
                    const role = i < 2 ? 'dps' : 'healer';
                    const profession = assignProfessionFromPool(player, role);
                    
                    team.push({
                        name: player.id,
                        role: role,
                        profession: profession
                    });
                }
                teams.push(team);
            }
            
            displayMatchResults(teams, tempShuffled);
            
            // 重要：不再删除报名信息！
            // 这行被移除了: database.ref('matchSignups').remove();
            
            showMessage('match-message', '抽签完成！您可以再次点击重新抽签', 'success');
        }
        
        // 从职业池中分配职业
        function assignProfessionFromPool(player, role) {
            const pool = role === 'dps' ? matchPool.dps : matchPool.healers;
            
            // 优先从玩家的超爱心法中选择（必须在池中）
            const playerLoveProfessions = (player.loveProfessions || []).filter(prof => 
                pool.includes(prof)
            );
            
            if (playerLoveProfessions.length > 0) {
                return playerLoveProfessions[Math.floor(Math.random() * playerLoveProfessions.length)];
            }
            
            // 否则从池中随机选择
            return pool[Math.floor(Math.random() * pool.length)];
        }
        
        // 显示匹配结果
        function displayMatchResults(teams, remaining) {
            const container = document.getElementById('match-results');
            const timestamp = new Date().toLocaleTimeString();
            
            container.innerHTML = `
                <h3>匹配结果 
                    <span style="font-size: 14px; color: #666; font-weight: normal;">
                        (${timestamp})
                    </span>
                </h3>
            `;
            
            teams.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';
                teamDiv.innerHTML = `
                    <div class="team-header">第 ${index + 1} 队</div>
                    ${team.map(member => `
                        <div>${member.name} - ${member.profession}</div>
                    `).join('')}
                `;
                container.appendChild(teamDiv);
            });
            
            if (remaining.length > 0) {
                container.innerHTML += `<p>轮空玩家：${remaining.map(u => u.id).join('、')}</p>`;
            }
        }
        
        // 显示创建队伍表单
        function showCreateTeamForm() {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            
            document.getElementById('create-team-form').style.display = 'block';
            document.getElementById('jjc-create-section').style.display = 'none';
            document.getElementById('team-tips').value = '';
            document.getElementById('team-date').value = getTodayDateString();
            document.getElementById('team-date').focus();
        }
        
        // 取消创建队伍
        function cancelCreateTeam() {
            document.getElementById('create-team-form').style.display = 'none';
            document.getElementById('jjc-create-section').style.display = 'block';
        }
        
        // 确认创建队伍
        function confirmCreateTeam() {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            
            const date = document.getElementById('team-date').value;
            const tips = document.getElementById('team-tips').value.trim();
            
            if (!date) {
                showMessage('jjc-message', '请选择开打日期', 'error');
                return;
            }
            
            // 获取用户的队伍计数
            const userCount = userTeamCounts[currentUser] || 0;
            const teamNumber = userCount + 1;
            
            // 更新计数
            database.ref(`userTeamCounts/${currentUser}`).set(teamNumber);
            
            const teamId = `team_${Date.now()}`;
            database.ref(`jjcTeams/${teamId}`).set({
                id: teamId,
                name: `${currentUser}的小队${teamNumber}`,
                date: date,
                tips: tips,
                creator: currentUser,
                members: {},
                dpsCount: 0,
                healerCount: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            cancelCreateTeam();
            showMessage('jjc-message', '队伍创建成功！', 'success');
        }
        
        // 判断职业类型
        function isProfessionDPS(profession) {
            return dpsProfessions.includes(profession);
        }
        
        // 删除队伍
        function deleteTeam(teamId) {
            if (!currentUser) return;
            
            if (confirm('确定要删除这个队伍吗？')) {
                database.ref(`jjcTeams/${teamId}`).remove();
                showMessage('jjc-message', '队伍已删除', 'success');
            }
        }
        
        // 更新队伍列表
        function updateTeamsList() {
            const container = document.getElementById('teams-list');
            container.innerHTML = '';
            
            // 按创建时间排序
            const sortedTeams = Object.values(jjcTeams).sort((a, b) => a.createdAt - b.createdAt);
            
            sortedTeams.forEach(team => {
                const membersList = Object.entries(team.members || {});
                const memberCount = membersList.length;
                const isFull = memberCount >= 3;
                const isCreator = currentUser && team.creator === currentUser;
                const isMember = currentUser && team.members && team.members[currentUser];
                
                // 计算DPS和治疗数量
                let currentDpsCount = 0;
                let currentHealerCount = 0;
                membersList.forEach(([id, prof]) => {
                    if (isProfessionDPS(prof)) {
                        currentDpsCount++;
                    } else {
                        currentHealerCount++;
                    }
                });
                
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-container';
                
                // 队伍基本信息
                const teamInfoDiv = document.createElement('div');
                teamInfoDiv.className = 'team-item';
                teamInfoDiv.innerHTML = `
                    <div class="team-info">
                        <div class="team-name">
                            ${team.name}
                            ${isFull ? '<span style="color: #f44336; margin-left: 8px;">[满员]</span>' : ''}
                            ${isCreator ? '<span style="color: #2196f3; margin-left: 8px;">[我创建的]</span>' : ''}
                        </div>
                        <div class="team-tips">${team.tips || '暂无说明'}</div>
                        <div class="team-meta">
                            开打日期：${formatDate(team.date)} | 创建时间：${formatTime(team.createdAt)}
                        </div>
                        <div class="team-members">
                            成员配置（${memberCount}/3）：
                            ${membersList.map(([id, prof]) => 
                                `<span class="member-slot ${isProfessionDPS(prof) ? 'dps' : 'healer'}">${id}(${prof})</span>`
                            ).join('')}
                            ${currentDpsCount < 2 ? Array(2 - currentDpsCount).fill('<span class="member-slot empty">DPS空位</span>').join('') : ''}
                            ${currentHealerCount < 1 ? '<span class="member-slot empty">奶妈空位</span>' : ''}
                        </div>
                    </div>
                `;
                teamDiv.appendChild(teamInfoDiv);
                
                // 创建者编辑区域
                if (isCreator) {
                    const editSection = document.createElement('div');
                    editSection.className = 'edit-tips-section';
                    editSection.innerHTML = `
                        <textarea id="tips-${team.id}" placeholder="注意加上开打时间和段位">${team.tips || ''}</textarea>
                        <button class="button small" onclick="updateTeamTips('${team.id}')">更新说明</button>
                    `;
                    teamDiv.appendChild(editSection);
                }
                
                // 加入队伍区域（只在已登录、未满员且当前用户未加入时显示）
                if (currentUser && !isFull && !isMember) {
                    const canJoinDPS = currentDpsCount < 2;
                    const canJoinHealer = currentHealerCount < 1;
                    
                    if (canJoinDPS || canJoinHealer) {
                        const joinSection = document.createElement('div');
                        joinSection.className = 'join-section';
                        
                        const availableProfessions = [];
                        if (canJoinDPS) {
                            availableProfessions.push(...dpsProfessions);
                        }
                        if (canJoinHealer) {
                            availableProfessions.push(...healerProfessions);
                        }
                        
                        joinSection.innerHTML = `
                            <label>选择心法加入队伍：</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                                <select id="join-${team.id}" style="width: 150px;">
                                    ${availableProfessions.map(prof => 
                                        `<option value="${prof}">${prof}</option>`
                                    ).join('')}
                                </select>
                                <button class="button small success" onclick="joinTeam('${team.id}')">加入队伍</button>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                需要：${canJoinDPS && currentDpsCount < 2 ? `${2 - currentDpsCount}个DPS ` : ''}${canJoinHealer && currentHealerCount < 1 ? `${1 - currentHealerCount}个奶妈` : ''}
                            </div>
                        `;
                        teamDiv.appendChild(joinSection);
                    }
                }
                
                // 操作按钮区域
                if (currentUser) {
                    const actionSection = document.createElement('div');
                    actionSection.className = 'action-section';
                    
                    // 退出队伍按钮（非创建者的成员可以退出）
                    if (isMember && !isCreator) {
                        actionSection.innerHTML += `
                            <button class="button small danger" onclick="leaveTeam('${team.id}')">退出队伍</button>
                        `;
                    }
                    
                    // 删除队伍按钮（只有创建者可以删除）
                    if (isCreator) {
                        actionSection.innerHTML += `
                            <button class="button small danger" onclick="deleteTeam('${team.id}')">删除队伍</button>
                        `;
                    }
                    
                    if (actionSection.innerHTML) {
                        teamDiv.appendChild(actionSection);
                    }
                }
                
                container.appendChild(teamDiv);
            });
            
            if (sortedTeams.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无队伍</p>';
            }
        }
        
        // 更新队伍说明
        function updateTeamTips(teamId) {
            const tips = document.getElementById(`tips-${teamId}`).value.trim();
            database.ref(`jjcTeams/${teamId}/tips`).set(tips);
            showMessage('jjc-message', '队伍说明更新成功！', 'success');
        }
        
        // 加入队伍
        function joinTeam(teamId) {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            
            const selectElement = document.getElementById(`join-${teamId}`);
            if (!selectElement) {
                showMessage('jjc-message', '加入失败，请刷新页面重试', 'error');
                return;
            }
            
            const profession = selectElement.value;
            
            // 检查职业类型是否还有空位
            const team = jjcTeams[teamId];
            const membersList = Object.entries(team.members || {});
            let currentDpsCount = 0;
            let currentHealerCount = 0;
            
            membersList.forEach(([id, prof]) => {
                if (isProfessionDPS(prof)) {
                    currentDpsCount++;
                } else {
                    currentHealerCount++;
                }
            });
            
            if (isProfessionDPS(profession) && currentDpsCount >= 2) {
                showMessage('jjc-message', 'DPS位置已满', 'error');
                return;
            }
            
            if (!isProfessionDPS(profession) && currentHealerCount >= 1) {
                showMessage('jjc-message', '奶妈位置已满', 'error');
                return;
            }
            
            database.ref(`jjcTeams/${teamId}/members/${currentUser}`).set(profession);
            showMessage('jjc-message', '加入队伍成功！', 'success');
        }
        
        // 退出队伍
        function leaveTeam(teamId) {
            if (!currentUser) return;
            
            database.ref(`jjcTeams/${teamId}/members/${currentUser}`).remove();
            showMessage('jjc-message', '已退出队伍', 'success');
        }
        
        // 洗牌算法
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // 显示消息
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        // 清除消息
        function clearMessages() {
            document.getElementById('user-message').innerHTML = '';
            document.getElementById('match-message').innerHTML = '';
            document.getElementById('jjc-message').innerHTML = '';
        }
        
        // 初始化
        window.onload = () => {
            initFirebase();
            initPoolProfessions();
            updateJJCLoginStatus();
            updateCurrentUserDisplay();
        };
    </script>
</body>
</html>
