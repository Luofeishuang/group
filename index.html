<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剑三活动匹配系统</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background-color: #2196f3;
            color: white;
        }

        .content {
            background-color: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-height: 500px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        h3 {
            color: #555;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2196f3;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .profession-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .tag {
            padding: 8px 12px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            user-select: none;
        }

        .tag:hover {
            border-color: #2196f3;
        }

        .tag.selected {
            background-color: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .tag.healer {
            background-color: #e8f5e9;
            border-color: #81c784;
            color: #388e3c;
        }

        .tag.healer.selected {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 5px 0;
        }

        .button:hover {
            background-color: #1976d2;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .button.success {
            background-color: #4caf50;
        }

        .button.danger {
            background-color: #f44336;
        }

        .button.small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .user-item, .team-item, .signup-item {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info, .team-info {
            flex: 1;
        }

        .user-name, .team-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .user-professions, .team-tips {
            font-size: 14px;
            color: #666;
        }

        /* 高亮队伍说明 */
        .team-tips {
            background-color: #fffde7;
            border: 1px solid #fff59d;
            border-radius: 6px;
            padding: 8px;
            line-height: 1.6;
        }

        .team-meta {
            font-size: 12px;
            color: #777;
            margin-top: 6px;
        }

        .status-bar {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #1976d2;
        }

        .status-bar.online {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .team-members {
            margin-top: 8px;
            font-size: 14px;
        }

        .member-slot {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #e3f2fd;
            border-radius: 4px;
            font-size: 12px;
        }

        .member-slot.empty {
            background-color: #f5f5f5;
            color: #999;
        }

        .pool-info {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .match-result {
            margin-top: 20px;
        }

        .team {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .team-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .rules-section {
            margin-bottom: 30px;
        }

        .rules-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .rule-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .rule-item h4 {
            color: #2196f3;
            margin-bottom: 8px;
        }

        .edit-tips-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .admin-section {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            color: #f57c00;
        }

        .team-container {
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .join-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f7ff;
            border: 1px solid #bbdefb;
            border-radius: 8px;
        }

        .action-section {
            margin-top: 10px;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .login-reminder {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #f57c00;
        }

        /* 通用模态框 */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff;
            border-radius: 10px;
            width: min(560px, 92vw);
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal h3 {
            margin: 0 0 12px 0;
        }
        .modal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }
        .text-danger { color: #d32f2f; font-size: 13px; margin-top: 6px; }

        @media (max-width: 600px) {
            .nav-tab {
                font-size: 14px;
                padding: 12px 8px;
            }
            
            .profession-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('user')">用户中心</button>
            <button class="nav-tab" onclick="switchTab('match')">对排活动</button>
            <button class="nav-tab" onclick="switchTab('jjc')">JJC组队</button>
            <button class="nav-tab" onclick="switchTab('rules')">活动规则</button>
        </div>
        <div id="user-status" class="status-bar" style="margin-top:10px;">
            当前用户：<span id="current-username">未登录</span>
        </div>
        
        <div class="content">
            <div id="connection-status" class="status-bar">
                正在连接服务器...
            </div>
            
            <!-- 用户中心页面 -->
            <div id="user-page" class="page active">
                <h2>用户中心</h2>
                <div id="user-message"></div>
                
                <!-- 注册/登录 -->
                <div class="form-group">
                    <label for="userId">用户ID</label>
                    <input type="text" id="userId" placeholder="请输入你的游戏ID">
                    <button class="button success" onclick="registerOrLogin()">注册/登录</button>
                </div>
                
                <!-- 编辑超爱心法 -->
                <div id="love-professions-section" style="display:none;">
                    <h3>编辑你的超爱心法（可多选）</h3>
                    <div class="form-group">
                        <label>DPS职业</label>
                        <div class="profession-grid" id="love-dps-container"></div>
                    </div>
                    <div class="form-group">
                        <label>奶妈职业</label>
                        <div class="profession-grid" id="love-healer-container"></div>
                    </div>
                    <button class="button" onclick="saveLoveProfessions()">保存超爱心法</button>
                </div>
                
                <!-- 用户列表 -->
                <h3>所有用户</h3>
                <div id="all-users-list"></div>
            </div>
            
            <!-- 对排活动页面 -->
            <div id="match-page" class="page">
                <h2>对排活动</h2>
                <div id="match-message"></div>
                
                <!-- 报名参加按钮 -->
                <div style="text-align: center; margin: 20px 0;">
                    <button class="button success" onclick="signupMatch()" id="signup-btn">报名参加</button>
                    <button class="button danger" onclick="cancelSignup()" id="cancel-signup-btn" style="display:none;">取消报名</button>
                </div>
                
                <!-- 管理员设置职业池 -->
                <div class="admin-section">
                    <h3>管理员：设置本次活动职业池</h3>
                    <div class="form-group">
                        <label>选择本次活动可用的DPS职业</label>
                        <div class="profession-grid" id="pool-dps-container"></div>
                    </div>
                    <div class="form-group">
                        <label>选择本次活动可用的奶妈职业</label>
                        <div class="profession-grid" id="pool-healer-container"></div>
                    </div>
                    <button class="button" onclick="saveMatchPool()">保存职业池设置</button>
                </div>
                
                <!-- 当前职业池 -->
                <div id="current-pool-info" class="pool-info" style="display:none;">
                    <h4>当前活动职业池</h4>
                    <div id="current-pool-content"></div>
                </div>
                
                <!-- 抽签按钮 -->
                <div class="status-bar">
                    当前报名人数：<span id="signup-count">0</span> 人（需要至少6人才能开始抽签）
                </div>
                <button class="button success" onclick="startMatching()" id="match-button" disabled style="width: 100%;">
                    开始抽签分队
                </button>
                
                <!-- 合并的用户列表 -->
                <div id="match-users-list" style="margin-top: 20px;"></div>
                
                <div id="match-results" class="match-result"></div>
            </div>
            
            <!-- JJC组队页面 -->
            <div id="jjc-page" class="page">
                <h2>JJC组队预约</h2>
                <div id="jjc-message"></div>
                
                <!-- 未登录提示 -->
                <div id="jjc-login-reminder" class="login-reminder" style="display:none;">
                    请先在用户中心登录后再进行组队操作
                </div>
                
                <!-- 创建队伍按钮 -->
                <div id="jjc-create-section" style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 10px; align-items: center;">
                        <label for="jjc-date">开打日期：</label>
                        <input type="date" id="jjc-date" />
                        <button class="button success" onclick="openCreateTeamModal()">创建新队伍</button>
                    </div>
                </div>
                
                <!-- 队伍列表 -->
                <h3>队伍列表</h3>
                <div id="teams-list"></div>
            </div>

            <!-- JJC: 创建队伍模态框 -->
            <div id="create-team-modal" class="modal-backdrop" role="dialog" aria-modal="true">
                <div class="modal">
                    <h3>创建新队伍</h3>
                    <div class="form-group" style="margin-top:8px;">
                        <label for="create-team-tips">队伍说明</label>
                        <textarea id="create-team-tips" placeholder="请输入队伍说明（建议包含开打时间与段位）"></textarea>
                        <div id="create-team-error" class="text-danger" style="display:none;">请输入队伍说明</div>
                    </div>
                    <div class="modal-actions">
                        <button class="button" onclick="closeCreateTeamModal()">取消</button>
                        <button class="button success" onclick="confirmCreateTeam()">确定创建</button>
                    </div>
                </div>
            </div>

            <!-- JJC: 组队限制提示模态框 -->
            <div id="limit-modal" class="modal-backdrop" role="dialog" aria-modal="true">
                <div class="modal">
                    <h3>无法加入队伍</h3>
                    <div id="limit-modal-text">组合不合法：必须为 2 个 DPS + 1 个奶妈</div>
                    <div class="modal-actions">
                        <button class="button success" onclick="closeLimitModal()">我知道了</button>
                    </div>
                </div>
            </div>
            
            <!-- 活动规则页面 -->
            <div id="rules-page" class="page">
                <h2>活动规则说明</h2>
                
                <div class="rules-section">
                    <h3>一、用户系统</h3>
                    <div class="rule-item">
                        <h4>注册与登录</h4>
                        <p>• 输入游戏ID即可快速注册</p>
                        <p>• 注册后可随时编辑自己的"超爱心法"</p>
                        <p>• 超爱心法将在匹配时优先分配给你</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3>二、对排活动</h3>
                    <div class="rule-item">
                        <h4>活动流程</h4>
                        <p>• 管理员先设置本次活动可用的职业池</p>
                        <p>• 玩家自行报名参加</p>
                        <p>• 报名满6人即可开始抽签分队</p>
                        <p>• 每队固定3人：2个DPS + 1个奶妈</p>
                    </div>
                    <div class="rule-item">
                        <h4>职业分配机制</h4>
                        <p>• 只会分配管理员设置的职业池中的职业</p>
                        <p>• 优先分配玩家设置的"超爱心法"职业</p>
                        <p>• 若超爱心法不在本次职业池中，则从池中随机分配</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3>三、JJC组队预约</h3>
                    <div class="rule-item">
                        <h4>组队说明</h4>
                        <p>• 点击创建按钮快速建队</p>
                        <p>• 每队最多3人，满员后自动关闭</p>
                        <p>• 加入队伍时需选择自己玩的心法</p>
                        <p>• 队伍创建者可以随时修改队伍说明</p>
                        <p>• 队伍创建者可以删除队伍</p>
                    </div>
                    <div class="rule-item">
                        <h4>注意事项</h4>
                        <p>• 队伍说明请注明开打时间和段位</p>
                        <p>• 加入前请确认自己的时间安排</p>
                        <p>• 请准时参加已加入的队伍活动</p>
                    </div>
                </div>
                
                <div class="rules-section">
                    <h3>四、职业列表</h3>
                    <div class="rule-item">
                        <h4>DPS职业</h4>
                        <p>和尚、冰心、花间游、气纯、剑纯、天策、藏剑、毒经、鲸鱼、田螺、明教、丐帮、苍云、莫问、霸刀、蓬莱、凌雪、衍天、无方、刀宗、万灵、段氏</p>
                    </div>
                    <div class="rule-item">
                        <h4>奶妈职业</h4>
                        <p>奶秀、奶毒、奶花、奶歌、奶药</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置 - 请替换为你自己的配置
        const firebaseConfig = {
            // 在这里填入你的Firebase配置
            apiKey: "AIzaSyAqAl228PwAygdjgmbI-B7zvpaGmgkNREE",
            authDomain: "user-ba917.firebaseapp.com",
            databaseURL: "https://user-ba917-default-rtdb.firebaseio.com",
            projectId: "user-ba917",
            storageBucket: "user-ba917.firebasestorage.app",
            messagingSenderId: "648289853069",
            appId: "1:648289853069:web:fbfdbd13b6023fca928cc4",
        };

        // 职业数据
        const dpsProfessions = [
            '和尚', '冰心', '花间游', '气纯', '剑纯', '天策', '藏剑', '毒经', 
            '鲸鱼', '田螺', '明教', '丐帮', '苍云', '莫问', '霸刀', '蓬莱', 
            '凌雪', '衍天', '无方', '刀宗', '万灵', '段氏'
        ];
        
        const healerProfessions = ['奶秀', '奶毒', '奶花', '奶歌', '奶药'];
        
        // 全局变量
        let database;
        let currentUser = null;
        let users = {};
        let matchPool = { dps: [], healers: [] };
        let matchSignups = {};
        let jjcTeams = {};
        let teamCounter = 0; // 队伍计数器
        let lastCleanupDate = null; // 记录上次清理日期
        
        // 初始化Firebase
        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // 监听连接状态
                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusEl = document.getElementById('connection-status');
                    if (connected) {
                        statusEl.className = 'status-bar online';
                        statusEl.innerHTML = '✅ 已连接到服务器';
                    } else {
                        statusEl.className = 'status-bar';
                        statusEl.innerHTML = '❌ 连接已断开';
                    }
                });
                
                // 监听数据变化
                database.ref('users').on('value', (snapshot) => {
                    users = snapshot.val() || {};
                    updateAllUsersList();
                    updateAvailableMatchUsers();
                });
                
                database.ref('matchPool').on('value', (snapshot) => {
                    matchPool = snapshot.val() || { dps: [], healers: [] };
                    updateMatchPoolDisplay();
                });
                
                database.ref('matchSignups').on('value', (snapshot) => {
                    matchSignups = snapshot.val() || {};
                    updateSignedUpUsers();
                    updateMatchPageUserStatus();
                    updateAvailableMatchUsers();
                });
                
                database.ref('jjcTeams').on('value', (snapshot) => {
                    jjcTeams = snapshot.val() || {};
                    updateTeamsList();
                });
                
                // 获取队伍计数器
                database.ref('teamCounter').on('value', (snapshot) => {
                    teamCounter = snapshot.val() || 0;
                });
                
                return true;
            } catch (error) {
                console.error('Firebase初始化失败:', error);
                return false;
            }
        }
        
        // 切换标签页
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-page`).classList.add('active');
            
            // 切换到JJC页面时检查登录状态
            if (tab === 'jjc') {
                updateJJCLoginStatus();
            }
            
            clearMessages();
        }
        
        // 更新JJC页面登录状态
        function updateJJCLoginStatus() {
            const loginReminder = document.getElementById('jjc-login-reminder');
            const createSection = document.getElementById('jjc-create-section');
            
            if (!currentUser) {
                loginReminder.style.display = 'block';
                createSection.style.display = 'none';
            } else {
                loginReminder.style.display = 'none';
                createSection.style.display = 'block';
            }
            
            // 更新队伍列表
            updateTeamsList();
        }
        
        // 注册或登录
        function registerOrLogin() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                showMessage('user-message', '请输入用户ID', 'error');
                return;
            }
            
            currentUser = userId;
            
            if (!users[userId]) {
                // 新用户注册
                database.ref(`users/${userId}`).set({
                    loveProfessions: [],
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                showMessage('user-message', `欢迎 ${userId}！请设置你的超爱心法`, 'success');
            } else {
                showMessage('user-message', `欢迎回来 ${userId}！`, 'success');
            }
            
            // 更新头部用户名
            updateUsernameStatus();
            // 显示超爱心法编辑区
            document.getElementById('love-professions-section').style.display = 'block';
            initLoveProfessions();
            
            // 更新对排和JJC页面的用户状态
            updateMatchPageUserStatus();
            updateJJCLoginStatus();
        }

        // 更新顶部当前用户显示
        function updateUsernameStatus() {
            const el = document.getElementById('current-username');
            if (el) {
                el.textContent = currentUser || '未登录';
            }
        }
        
        // 初始化超爱心法选择
        function initLoveProfessions() {
            const dpsContainer = document.getElementById('love-dps-container');
            const healerContainer = document.getElementById('love-healer-container');
            
            dpsContainer.innerHTML = '';
            healerContainer.innerHTML = '';
            
            const userLoveProfessions = users[currentUser]?.loveProfessions || [];
            
            dpsProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'dps', userLoveProfessions.includes(prof));
                dpsContainer.appendChild(tag);
            });
            
            healerProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'healer', userLoveProfessions.includes(prof));
                healerContainer.appendChild(tag);
            });
        }
        
        // 初始化职业池选择（管理员）
        function initPoolProfessions() {
            const dpsContainer = document.getElementById('pool-dps-container');
            const healerContainer = document.getElementById('pool-healer-container');
            
            dpsContainer.innerHTML = '';
            healerContainer.innerHTML = '';
            
            dpsProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'dps', matchPool.dps?.includes(prof));
                dpsContainer.appendChild(tag);
            });
            
            healerProfessions.forEach(prof => {
                const tag = createProfessionTag(prof, 'healer', matchPool.healers?.includes(prof));
                healerContainer.appendChild(tag);
            });
        }
        
        // 创建职业标签
        function createProfessionTag(profession, type, selected = false) {
            const tag = document.createElement('div');
            tag.className = `tag ${type} ${selected ? 'selected' : ''}`;
            tag.textContent = profession;
            tag.onclick = () => tag.classList.toggle('selected');
            return tag;
        }
        
        // 保存超爱心法
        function saveLoveProfessions() {
            if (!currentUser) {
                showMessage('user-message', '请先登录', 'error');
                return;
            }
            
            const selected = [...document.querySelectorAll('#love-professions-section .tag.selected')]
                .map(tag => tag.textContent);
            
            database.ref(`users/${currentUser}/loveProfessions`).set(selected);
            showMessage('user-message', '超爱心法保存成功！', 'success');
        }
        
        // 保存职业池设置（管理员）
        function saveMatchPool() {
            const selectedDps = [...document.querySelectorAll('#pool-dps-container .tag.selected')]
                .map(tag => tag.textContent);
            const selectedHealers = [...document.querySelectorAll('#pool-healer-container .tag.selected')]
                .map(tag => tag.textContent);
            
            if (selectedDps.length === 0 || selectedHealers.length === 0) {
                showMessage('match-message', '请至少选择一个DPS和一个奶妈职业', 'error');
                return;
            }
            
            database.ref('matchPool').set({
                dps: selectedDps,
                healers: selectedHealers
            });
            
            showMessage('match-message', '职业池设置成功！', 'success');
        }
        
        // 更新用户列表
        function updateAllUsersList() {
            const container = document.getElementById('all-users-list');
            container.innerHTML = '';
            
            Object.entries(users).forEach(([userId, user]) => {
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${userId}</div>
                        <div class="user-professions">超爱心法：${user.loveProfessions?.join('、') || '未设置'}</div>
                    </div>
                    <div>
                        <button class="button small danger" onclick="deleteUser('${userId}')">删除用户</button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无注册用户</p>';
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm(`确定要删除用户 ${userId} 吗？`)) {
                database.ref(`users/${userId}`).remove();
                // 同时删除该用户的报名信息
                database.ref(`matchSignups/${userId}`).remove();
                // 删除该用户在JJC队伍中的信息
                Object.keys(jjcTeams).forEach(teamId => {
                    database.ref(`jjcTeams/${teamId}/members/${userId}`).remove();
                });
                showMessage('user-message', `用户 ${userId} 已删除`, 'success');
            }
        }
        
        // 更新职业池显示
        function updateMatchPoolDisplay() {
            initPoolProfessions();
            
            if (matchPool.dps?.length > 0 || matchPool.healers?.length > 0) {
                document.getElementById('current-pool-info').style.display = 'block';
                document.getElementById('current-pool-content').innerHTML = `
                    <div><strong>DPS职业：</strong>${matchPool.dps?.join('、') || '未设置'}</div>
                    <div><strong>奶妈职业：</strong>${matchPool.healers?.join('、') || '未设置'}</div>
                `;
            } else {
                document.getElementById('current-pool-info').style.display = 'none';
            }
        }
        
        // 更新可报名用户列表
        function updateAvailableMatchUsers() {
            const container = document.getElementById('match-users-list');
            if (!container) return;
            container.innerHTML = '';
            
            Object.entries(users).forEach(([userId, user]) => {
                const isSignedUp = !!matchSignups[userId];
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${userId}</div>
                        <div class="user-professions">超爱心法：${user.loveProfessions?.join('、') || '未设置'}</div>
                    </div>
                    <div>
                        ${currentUser === userId ? 
                            (isSignedUp ? 
                                '<span style="color: #4caf50;">已报名</span>' : 
                                '<button class="button small success" onclick="quickSignup()">报名</button>'
                            ) : 
                            (isSignedUp ? '<span style="color: #4caf50;">已报名</span>' : '<span style="color: #999;">未报名</span>')
                        }
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无用户</p>';
            }
        }
        
        // 快速报名
        function quickSignup() {
            if (!currentUser) {
                showMessage('match-message', '请先登录', 'error');
                return;
            }
            signupMatch();
        }
        
        // 报名对排
        function signupMatch() {
            if (!currentUser) {
                showMessage('match-message', '请先登录', 'error');
                return;
            }
            
            if (!matchPool.dps?.length || !matchPool.healers?.length) {
                showMessage('match-message', '管理员还未设置职业池，请稍后再试', 'error');
                return;
            }
            
            database.ref(`matchSignups/${currentUser}`).set({
                userId: currentUser,
                signedUpAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            showMessage('match-message', `报名成功！`, 'success');
            updateMatchPageUserStatus();
        }
        
        // 取消报名
        function cancelSignup() {
            if (!currentUser) return;
            
            database.ref(`matchSignups/${currentUser}`).remove();
            showMessage('match-message', '已取消报名', 'success');
            updateMatchPageUserStatus();
        }
        
        // 更新用户在对排页面的状态
        function updateMatchPageUserStatus() {
            const isSigned = currentUser && matchSignups[currentUser];
            document.getElementById('signup-btn').style.display = isSigned ? 'none' : 'inline-block';
            document.getElementById('cancel-signup-btn').style.display = isSigned ? 'inline-block' : 'none';
            // 触发列表刷新，让颜色标识即时更新
            updateAvailableMatchUsers();
        }
        
        // 更新已报名用户列表
        function updateSignedUpUsers() {
            const container = document.getElementById('signed-up-users');
            container.innerHTML = '';
            
            const signupsList = Object.values(matchSignups);
            const signupCount = signupsList.length;
            
            document.getElementById('signup-count').textContent = signupCount;
            document.getElementById('match-button').disabled = signupCount < 6;
            
            signupsList.forEach(signup => {
                const user = users[signup.userId];
                if (user) {
                    const item = document.createElement('div');
                    item.className = 'signup-item';
                    item.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${signup.userId}</div>
                            <div class="user-professions">超爱心法：${user.loveProfessions?.join('、') || '未设置'}</div>
                        </div>
                    `;
                    container.appendChild(item);
                }
            });
            
            if (signupsList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无报名用户</p>';
            }
        }
        
        // 开始匹配
        function startMatching() {
            const signupsList = Object.values(matchSignups).map(signup => ({
                id: signup.userId,
                ...users[signup.userId]
            }));
            
            if (signupsList.length < 6) {
                showMessage('match-message', '报名人数不足6人', 'error');
                return;
            }
            
            // 随机打乱用户
            const shuffled = shuffle([...signupsList]);
            const teams = [];
            
            // 分配队伍
            while (shuffled.length >= 3) {
                const team = [];
                for (let i = 0; i < 3; i++) {
                    const player = shuffled.shift();
                    const role = i < 2 ? 'dps' : 'healer';
                    const profession = assignProfessionFromPool(player, role);
                    
                    team.push({
                        name: player.id,
                        role: role,
                        profession: profession
                    });
                }
                teams.push(team);
            }
            
            displayMatchResults(teams, shuffled);
        }
        
        // 从职业池中分配职业
        function assignProfessionFromPool(player, role) {
            const pool = role === 'dps' ? matchPool.dps : matchPool.healers;
            
            // 优先从玩家的超爱心法中选择（必须在池中）
            const playerLoveProfessions = (player.loveProfessions || []).filter(prof => 
                pool.includes(prof)
            );
            
            if (playerLoveProfessions.length > 0) {
                return playerLoveProfessions[Math.floor(Math.random() * playerLoveProfessions.length)];
            }
            
            // 否则从池中随机选择
            return pool[Math.floor(Math.random() * pool.length)];
        }
        
        // 显示匹配结果
        function displayMatchResults(teams, remaining) {
            const container = document.getElementById('match-results');
            container.innerHTML = '<h3>匹配结果</h3>';
            
            teams.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';
                teamDiv.innerHTML = `
                    <div class="team-header">第 ${index + 1} 队</div>
                    ${team.map(member => `
                        <div>${member.name} - ${member.profession}</div>
                    `).join('')}
                `;
                container.appendChild(teamDiv);
            });
            
            if (remaining.length > 0) {
                container.innerHTML += `<p>轮空玩家：${remaining.map(u => u.id).join('、')}</p>`;
            }
            
            // 清空报名列表
            database.ref('matchSignups').remove();
        }
        
        // 打开/关闭 创建队伍模态
        function openCreateTeamModal() {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            document.getElementById('create-team-tips').value = '';
            document.getElementById('create-team-error').style.display = 'none';
            document.getElementById('create-team-modal').style.display = 'flex';
        }
        function closeCreateTeamModal() {
            document.getElementById('create-team-modal').style.display = 'none';
        }

        function confirmCreateTeam() {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            // 读取开打日期，默认当天
            const dateInput = document.getElementById('jjc-date');
            const selectedDate = (dateInput && dateInput.value) ? dateInput.value : formatDateYYYYMMDD(new Date());
            // 读取模态中的队伍说明
            const tipsInput = (document.getElementById('create-team-tips').value || '').trim();
            if (!tipsInput) {
                document.getElementById('create-team-error').style.display = 'block';
                return;
            }
            
            // 增加计数器
            const newTeamNumber = teamCounter + 1;
            database.ref('teamCounter').set(newTeamNumber);
            
            const teamId = `team_${Date.now()}`;
            database.ref(`jjcTeams/${teamId}`).set({
                id: teamId,
                name: `${currentUser}的小队${newTeamNumber}`,
                tips: tipsInput,
                creator: currentUser,
                members: {},
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                matchDate: selectedDate
            });
            
            closeCreateTeamModal();
            showMessage('jjc-message', '队伍创建成功！', 'success');
        }
        
        // 删除队伍
        function deleteTeam(teamId) {
            if (!currentUser) return;
            
            if (confirm('确定要删除这个队伍吗？')) {
                database.ref(`jjcTeams/${teamId}`).remove();
                showMessage('jjc-message', '队伍已删除', 'success');
            }
        }
        
        // 更新队伍列表
        function updateTeamsList() {
            const container = document.getElementById('teams-list');
            container.innerHTML = '';
            
            // 按创建时间排序
            const sortedTeams = Object.values(jjcTeams).sort((a, b) => a.createdAt - b.createdAt);
            
            sortedTeams.forEach(team => {
                const memberCount = Object.keys(team.members || {}).length;
                const isFull = memberCount >= 3;
                const isCreator = currentUser && team.creator === currentUser;
                const isMember = currentUser && team.members && team.members[currentUser];
                
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-container';
                
                // 队伍基本信息
                const teamInfoDiv = document.createElement('div');
                teamInfoDiv.className = 'team-item';
                teamInfoDiv.innerHTML = `
                    <div class="team-info">
                        <div class="team-name">
                            ${team.name}
                            ${isFull ? '<span style="color: #f44336; margin-left: 8px;">[满员]</span>' : ''}
                            ${isCreator ? '<span style="color: #2196f3; margin-left: 8px;">[我创建的]</span>' : ''}
                        </div>
                        <div class="team-tips">${team.tips || '暂无说明（注意加上开打时间和段位）'}</div>
                        <div class="team-tips">创建时间：${formatDateTime(team.createdAt)} | 开打日期：${team.matchDate || formatDateYYYYMMDD(new Date())}</div>
                        <div class="team-members">
                            成员（${memberCount}/3）：
                            ${Object.entries(team.members || {}).map(([id, prof]) => 
                                `<span class="member-slot">${id}(${prof})</span>`
                            ).join('')}
                            ${Array(3 - memberCount).fill('<span class="member-slot empty">空位</span>').join('')}
                        </div>
                    </div>
                `;
                teamDiv.appendChild(teamInfoDiv);
                
                // 创建者编辑区域
                if (isCreator) {
                    const editSection = document.createElement('div');
                    editSection.className = 'edit-tips-section';
                    editSection.innerHTML = `
                        <textarea id="tips-${team.id}" placeholder="注意加上开打时间和段位">${team.tips || ''}</textarea>
                        <button class="button small" onclick="updateTeamTips('${team.id}')">更新说明</button>
                        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                            <label for="md-${team.id}">修改开打日期：</label>
                            <input type="date" id="md-${team.id}" value="${team.matchDate || formatDateYYYYMMDD(new Date())}" />
                            <button class="button small" onclick="updateTeamMatchDate('${team.id}')">保存日期</button>
                        </div>
                    `;
                    teamDiv.appendChild(editSection);
                }
                
                // 加入队伍区域（只在已登录、未满员且当前用户未加入时显示）
                if (currentUser && !isFull && !isMember) {
                    const joinSection = document.createElement('div');
                    joinSection.className = 'join-section';
                    joinSection.innerHTML = `
                        <label>选择心法加入队伍：</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <select id="join-${team.id}" style="width: 150px;">
                                ${[...dpsProfessions, ...healerProfessions].map(prof => 
                                    `<option value="${prof}">${prof}</option>`
                                ).join('')}
                            </select>
                            <button class="button small success" onclick="joinTeam('${team.id}')">加入队伍</button>
                        </div>
                    `;
                    teamDiv.appendChild(joinSection);
                }
                
                // 操作按钮区域
                if (currentUser) {
                    const actionSection = document.createElement('div');
                    actionSection.className = 'action-section';
                    
                    // 退出队伍按钮（非创建者的成员可以退出）
                    if (isMember && !isCreator) {
                        actionSection.innerHTML += `
                            <button class="button small danger" onclick="leaveTeam('${team.id}')">退出队伍</button>
                        `;
                    }
                    
                    // 删除队伍按钮（只有创建者可以删除）
                    if (isCreator) {
                        actionSection.innerHTML += `
                            <button class="button small danger" onclick="deleteTeam('${team.id}')">删除队伍</button>
                        `;
                    }
                    
                    if (actionSection.innerHTML) {
                        teamDiv.appendChild(actionSection);
                    }
                }
                
                container.appendChild(teamDiv);
            });
            
            if (sortedTeams.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">暂无队伍</p>';
            }
        }
        
        // 更新队伍说明
        function updateTeamTips(teamId) {
            const tips = document.getElementById(`tips-${teamId}`).value.trim();
            database.ref(`jjcTeams/${teamId}/tips`).set(tips);
            showMessage('jjc-message', '队伍说明更新成功！', 'success');
        }
        
        // 关闭限制提示
        function closeLimitModal() {
            document.getElementById('limit-modal').style.display = 'none';
        }

        // 加入队伍（限制2个DPS、1个奶妈）
        function joinTeam(teamId) {
            if (!currentUser) {
                showMessage('jjc-message', '请先登录', 'error');
                return;
            }
            
            const selectElement = document.getElementById(`join-${teamId}`);
            if (!selectElement) {
                showMessage('jjc-message', '加入失败，请刷新页面重试', 'error');
                return;
            }
            
            const profession = selectElement.value;
            const team = jjcTeams[teamId];
            const members = team?.members || {};
            const values = Object.values(members);
            const dpsCount = values.filter(p => dpsProfessions.includes(p)).length;
            const healerCount = values.filter(p => healerProfessions.includes(p)).length;
            
            if (dpsProfessions.includes(profession) && dpsCount >= 2) {
                document.getElementById('limit-modal-text').textContent = '该队伍DPS名额已满（最多2个DPS + 1个奶妈）';
                document.getElementById('limit-modal').style.display = 'flex';
                showMessage('jjc-message', '该队伍DPS名额已满（最多2个）', 'error');
                return;
            }
            if (healerProfessions.includes(profession) && healerCount >= 1) {
                document.getElementById('limit-modal-text').textContent = '该队伍奶妈名额已满（最多2个DPS + 1个奶妈）';
                document.getElementById('limit-modal').style.display = 'flex';
                showMessage('jjc-message', '该队伍奶妈名额已满（最多1个）', 'error');
                return;
            }
            
            // 最终组合校验：加入后最多3人且满足2DPS+1奶
            const nextValues = [...values, profession];
            const nextDps = nextValues.filter(p => dpsProfessions.includes(p)).length;
            const nextHealer = nextValues.filter(p => healerProfessions.includes(p)).length;
            if (nextValues.length > 3 || nextDps > 2 || nextHealer > 1) {
                document.getElementById('limit-modal-text').textContent = '组合不合法：必须为 2 个 DPS + 1 个奶妈';
                document.getElementById('limit-modal').style.display = 'flex';
                showMessage('jjc-message', '组合不合法：必须为2个DPS + 1个奶妈', 'error');
                return;
            }

            database.ref(`jjcTeams/${teamId}/members/${currentUser}`).set(profession);
            showMessage('jjc-message', '加入队伍成功！', 'success');
        }
        
        // 退出队伍
        function leaveTeam(teamId) {
            if (!currentUser) return;
            
            database.ref(`jjcTeams/${teamId}/members/${currentUser}`).remove();
            showMessage('jjc-message', '已退出队伍', 'success');
        }
        
        // 洗牌算法
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // 显示消息
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        // 清除消息
        function clearMessages() {
            document.getElementById('user-message').innerHTML = '';
            document.getElementById('match-message').innerHTML = '';
            document.getElementById('jjc-message').innerHTML = '';
        }
        
        // 初始化
        window.onload = () => {
            initFirebase();
            initPoolProfessions();
            updateJJCLoginStatus();
            updateUsernameStatus();
            // 设置开打日期默认今天
            const dateInput = document.getElementById('jjc-date');
            if (dateInput) dateInput.value = formatDateYYYYMMDD(new Date());
            // 启动每日清理任务（每分钟检查一次是否跨天）
            setupDailyCleanup();
        };

        // 工具：格式化日期 YYYY-MM-DD
        function formatDateYYYYMMDD(date) {
            const d = new Date(date);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // 工具：格式化时间 yyyy-MM-dd HH:mm
        function formatDateTime(ts) {
            const d = new Date(ts);
            const ymd = formatDateYYYYMMDD(d);
            const h = String(d.getHours()).padStart(2, '0');
            const mi = String(d.getMinutes()).padStart(2, '0');
            return `${ymd} ${h}:${mi}`;
        }

        // 更新队伍开打日期（创建者）
        function updateTeamMatchDate(teamId) {
            const input = document.getElementById(`md-${teamId}`);
            if (!input || !input.value) return;
            database.ref(`jjcTeams/${teamId}/matchDate`).set(input.value);
            showMessage('jjc-message', '开打日期已更新', 'success');
        }

        // 设置每日清理任务：每天00:00清理过期队伍
        function setupDailyCleanup() {
            lastCleanupDate = formatDateYYYYMMDD(new Date());
            setInterval(() => {
                const nowDate = formatDateYYYYMMDD(new Date());
                if (nowDate !== lastCleanupDate) {
                    lastCleanupDate = nowDate;
                    cleanupExpiredTeams(nowDate);
                }
            }, 60 * 1000);
        }

        // 清理开打日期早于今天的队伍
        function cleanupExpiredTeams(todayStr) {
            const today = todayStr || formatDateYYYYMMDD(new Date());
            const updates = {};
            Object.values(jjcTeams).forEach(team => {
                if (team.matchDate && team.matchDate < today) {
                    updates[team.id] = null;
                }
            });
            if (Object.keys(updates).length > 0) {
                database.ref('jjcTeams').update(updates);
                showMessage('jjc-message', '已清理过期队伍', 'success');
            }
        }
    </script>
</body>
</html>
